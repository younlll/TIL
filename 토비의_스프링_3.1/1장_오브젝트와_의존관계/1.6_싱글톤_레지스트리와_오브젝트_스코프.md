# 1.6 싱글톤 레지스트리와 오브젝트 스코프
### 오브젝트의 동일성과 동등성
`동일성(identify)`은 두 개의 오브젝트가 완전히 같은 오브젝트를 말한다</br>
사실은 하나의 오브젝트만 존재하는 것이고 두 개의 오브젝트 레퍼런스 변수를 갖고 있을 뿐이다</br>
\== 연산자로 비교한다</br>
`동등성(equality)`는 동일한 정보를 담고있는 오브젝트를 말한다</br>
두 개의 각기 다른 오브젝트가 메모리상에 존재하는 것인데, 오브젝트의 동등성 기준에 따라 두 오브젝트의 정보가 동등하다고 판단하는 것</br>
equals() 연산자로 비교한다</br></br>
스프링은 여러번에 걸쳐 빈을 요청하더라도 동일한 오브젝트를 돌려준다</br></br>

## 싱글톤 레지스트리로서의 애플리케이션 컨텍스트
* 스프링은 기본적으로 내부에서 생성하는 빈 오프젝트를 모두 싱글톤으로 만든다

### 서버 애플리케이션과 싱글톤
* 스프링이 싱글톤으로 빈을 만드는 이유는 스프링이 주로 적용되는 대상이 자바 엔터프라이즈 기술을 사용하는 서버환경이기 때문이다
* 다양한 기능을 담당하는 오브젝트들이 참여하는 계층형 구조로 이뤄진 경우가 대부분이다
* 매번 요청이 올때마다 각 로직들을 담당하는 오브젝트를 새로 만들어서 사용하게 된다면 서버가 감당하기 힘들다
* `서블릿`은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트라고 할 수 있다
* 대부분 멀티스레드 환경에서 싱글톤으로 동작한다
* 서블릿 클래스당 하나의 오브젝트만 만들어두고, 사용자의 요청을 담당하는 여러 스레드에서 하나의 오브젝트를 공유해 동시에 사용한다

**싱글톤 패턴**
* 어떤 클래스를 애플리케이션 내에서 제한된 인스턴스 개수, 이름처럼 주로 하나만 존재하도록 강제하는 패턴이다
* 구현방법
  * 클래스 밖에서 오브젝트를 생성하지 못하도록 생성자를 private하게 만든다
  * 생성된 싱글톤 오브젝트를 저장할 수 있는 자신과 같은 타입의 스태틱 필드를 정의한다
  * 스태틱 팩토리 메소드인 getInstance()를 만들고 이 메소드가 최초로 호출되는 시점에서 한번만 오브젝트가 만들어지게 한다
  * 한번 오브젝트가 만들어지고 난 후에는 getInstance() 메소드를 통해 이미 만들어져 스태틱 필드에 저장해둔 오브젝트를 넘겨준다



### 싱글톤 패턴의 한계
**private 생성자를 갖고 있기 때문에 상속할 수 없다**
* private 생성자를 가진 클래스는 다른 생성자가 없다면 상속이 불가능 하다
* 객체지향의 장점인 상속과 이를 이용한 다형성을 적용할 수 없다

**싱글톤은 테스트하기 힘들다**
* 싱글톤은 만들어지는 방식이 제한적이어서 테스트 때 목 오브젝트 등으로 대체하기가 힘들다
* 사용할 오브젝트를 다이내믹하게 주입하기도 힘들기 때문에 필요한 오브젝트는 직접 오브젝트를 만들어 사용할 수 밖에 없어 테스트용 오브젝트로 대체하기 힘들다

**서버환경에서는 싱글톤이 하나만 만들어지는 것을 보장하지 못한다**
* 여러 개의 JVM에 분산돼서 설치가 되는 경우에는 각각 독립적으로 오브젝트가 생기기 때문에 싱글톤으로서 가치가 떨어진다

**싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다**
* 싱글톤의 스태틱 메소드를 이용해 언제든지 싱글톤에 쉽게 접근할 수 있다
* 그러다보면 자연스럽게 전역상태로 사용되기 쉽다
* 아무 객체나 자유롭게 접근하고 수정하고 공유할 수 있는 전역산태를 갖는 것은 객체지향 프로그래밍에서는 권장되지 않는 프로그래밍 모델이다



### 싱글톤 레지스트리
`싱글톤 레지스트리`란 스프링에서 직접 싱글톤 형태으ㅢ 오브젝트를 만들고 관리하는 기능을 제공하는 것을 말한다</br>
스프링의 싱글톤 레지스트리 덕분에 싱글톤 방식으로 사용될 애플리케이션 클래스라도 **public 생성자** 를 갖을 수 있다</br>
테스트 환경에서 자유롭게 오브젝트를 만들 수 있고, 테스트를 위한 목 오브젝트로 대체하는 것도 간단하다</br>
스프링이 지지하는 객체지향적인 설계방식과 원칙, 디자인 패턴 등을 적용하는 데 아무런 제약이 없다</br>
스프링은 IoC 컨테이너일 뿐만 아니라, 고전적인 싱글톤 패턴을 대신해서 싱글톤을 만들고 관리해</br></br>

## 싱글톤과 오브젝트의 상태
### 싱글톤으로 만들어질 때 주의할 점
* 멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우에는 상태정보를 내부에 갖고 있지 않은 무상태 방식으로 만들어져야 한다
* 다중 사용자의 요청을 한번에 처리하는 스레드들이 동시에 싱글톤 오브젝트의 인스턴스 변수를 수정하는 것은 위험하다
  * 저장할 공간이 하나뿐이니 서로 값을 덮어쓰고 자신이 저장하지 않은 값을 읽어올 수 있다
* 파라미터와 로컬변수, 리턴값들을 이용해 저장할 독립적인 공간을 만들어 싱글톤이라 해도 여러 스레드가 변수의 값을 덮어 쓸 일을 없앤다
* 만약, 단순 읽기전용 값이라면 **static final이나 final** 로 선언하는 것이 좋다

```java
public class UserDao {
    private ConnectionMaker connectionMaker;    // 초기에 설정하면 사용 중에는 바뀌지 않는 읽기전용 인스턴스 변수
    
    // 매번 새로운 값으로 바뀌는 정보를 담은 인스턴스 변수, 심각한 문제 발생
    private Connection c;
    private User user;
    
    // ...
}
```

## 스프링 빈의 스코프
* 스프링이 관리하는 오브젝트(빈)가 생성되고 존재하고 적용되는 범위를 **빈의 스코프** 라고 한다
* 스프링 빈의 기본 스코프는 싱글톤이다
* 싱글톤 스코프는 컨테이너 내에 한 개의 오브젝트만 만들어져서 강제로 제고하지 않는 한 스프링 컨테이너가 존재하는 동안 유지된다
* 싱글톤 외의 스포크를 갖을수 있다
* 대표적으로 프로토타입 스코프가 있따
* 프로토타입은 싱글톤과 달리 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 만들어 준다

</br>

### Reference
> 토비의 스프링3.1 Vol.1 스프링의 이해와 원리 - 이일민 지음
